name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run remote deploy after publishing image"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/e2br3-web-server

jobs:
  publish:
    name: Build and Publish Image
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate GHCR push credentials
        run: |
          test -n "${{ secrets.GHCR_USERNAME }}"
          test -n "${{ secrets.GHCR_TOKEN }}"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.sha }}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy (AWS SSM)
    runs-on: ubuntu-latest
    needs: publish
    if: ${{ false }} # Temporarily disabled: publish-only mode until AWS IAM/OIDC is ready

    steps:
      - name: Validate required deploy secrets
        run: |
          test -n "${{ secrets.AWS_ROLE_TO_ASSUME }}"
          test -n "${{ secrets.AWS_REGION }}"
          test -n "${{ secrets.AWS_SSM_TARGET }}"
          test -n "${{ secrets.DEPLOY_COMMAND }}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy via AWS Systems Manager
        env:
          IMAGE_REF: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          AWS_SSM_TARGET: ${{ secrets.AWS_SSM_TARGET }}
          DEPLOY_COMMAND: ${{ secrets.DEPLOY_COMMAND }}
        run: |
          set -eu
          commands_json="$(jq -n \
            --arg image_ref "${IMAGE_REF}" \
            --arg ghcr_username "${GHCR_USERNAME}" \
            --arg ghcr_token "${GHCR_TOKEN}" \
            --arg deploy_command "${DEPLOY_COMMAND}" \
            '[
              "set -eu",
              "IMAGE_REF=\($image_ref)",
              "GHCR_USERNAME=\($ghcr_username)",
              "GHCR_TOKEN=\($ghcr_token)",
              "DEPLOY_COMMAND=\($deploy_command)",
              "if [ -n \"${GHCR_USERNAME:-}\" ] && [ -n \"${GHCR_TOKEN:-}\" ]; then echo \"${GHCR_TOKEN}\" | docker login ghcr.io -u \"${GHCR_USERNAME}\" --password-stdin; fi",
              "echo \"Deploying image: ${IMAGE_REF}\"",
              "if command -v bash >/dev/null 2>&1; then bash -lc \"${DEPLOY_COMMAND}\"; else sh -c \"${DEPLOY_COMMAND}\"; fi"
            ]'
          )"

          command_id="$(
            aws ssm send-command \
              --instance-ids "${AWS_SSM_TARGET}" \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy ${IMAGE_REF}" \
              --parameters "commands=${commands_json}" \
              --query "Command.CommandId" \
              --output text
          )"

          echo "SSM command id: ${command_id}"
          aws ssm wait command-executed --command-id "${command_id}" --instance-id "${AWS_SSM_TARGET}"
          aws ssm get-command-invocation \
            --command-id "${command_id}" \
            --instance-id "${AWS_SSM_TARGET}" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent}" \
            --output json
